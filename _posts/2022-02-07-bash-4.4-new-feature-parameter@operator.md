---
layout: post
title: "bash-4.4 new feature ${param@Q} ${parameter@operator}"
---

## What
最近浏览 bash man page，看到一个特性 ${parameter@operator}，发现是 bash-4.4 引入的  
(RHEL-7 默认 bash-4.2.x, RHEL-8 默认 bash-4.4.x)。其中 ${var@Q} 很好的解决了我的一  
个痛点：自动给变量输出加上引用(但是边界处理有点瑕疵)；让我们看看它的效果

## Examples
var
```
$ var='abc\$ "'
$ echo \$var=$var --- \${var@Q}=${var@Q}
$var=abc\$ " --- ${var@Q}='abc\$ "'

$ var=\''abc\$'\'xyz\'
$ echo \$var=$var --- \${var@Q}=${var@Q}
$var='abc\$'xyz' --- ${var@Q}=''\''abc\$'\''xyz'\'''   #前后会多出来两对加引用的空字符 ''

$ var=
$ echo \$var=$var --- \${var@Q}=${var@Q}
$var= --- ${var@Q}=''

$ var=___$'a\nb .*-= z"'\'
$ echo ${var}
___a b .*-= z"'
$ echo "${var}"
___a
b .*-= z"'
$ echo ${var@Q}
$'___a\nb .*-= z"\''
$ echo "${var@Q}"
$'___a\nb .*-= z"\''
```

array
```
$ args() { echo "$@"; echo ${@@Q}; echo "${@@Q}"; echo "${*@Q}"; }
$ args === abc "" \' \" \$ ' '  $'a\nb"'\'
=== abc  ' " $   a
b"'
'===' 'abc' '' \' '"' '$' ' ' $'a\nb"\''
'===' 'abc' '' \' '"' '$' ' ' $'a\nb"\''
'===' 'abc' '' \' '"' '$' ' ' $'a\nb"\''
```


## 用途
对我来说，这个功能很适合编写 run() exec() 之类函数: run command arg1 arg2 arg3 ,,,
以往如果需要从命令行透传一个命令行，然后在脚本里 bash -c "" 执行，会遇到很大的麻烦  

比如下面这个函数 \_nsexec() 如果遇到参数里有特殊字符的化，是需要特殊额外加一层保护的  
```
_nsexec() {
        local initpid=$1
        shift
        nsenter --target "$initpid" --mount --uts --ipc --net --pid -- bash -c "$*"
}
```

如果希望很自然的方式运行指定的命令行，需要改为如下写法:
```
getSafeCommandLine() {
        for at; do
                if [[ -z "$at" ]]; then
                        echo -n "'' "
                elif [[ "$at" =~ \' ]]; then
                        echo -n "$at" | sed -r -e "s/'+/'\"&\"'/g" -e "s/^/'/" -e "s/$/' /" -e "s/^''//" -e "s/'' $/ /"
                else
                        echo -n "'$at' "
                fi
        done
        echo
}
_nsexec() {
        local initpid=$1
        shift
        nsenter --target "$initpid" --mount --uts --ipc --net --pid -- bash -c "$(getSafeCommandLine "$@")"
}
```

现在有了 ${@@Q} ${\*@Q} 的话，就不需要自己再实现 getSafeCommandLine 了:
```
_nsexec() {
        local initpid=$1
        shift
        nsenter --target "$initpid" --mount --uts --ipc --net --pid -- bash -c "${*@Q}"
}
```
